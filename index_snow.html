<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Magic Christmas ‚ùÑÔ∏è</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

<style>
body { margin:0; overflow:hidden; background:black; font-family:Segoe UI,sans-serif; }
#canvas-container { width:100%; height:100vh; }
#ui-layer {
    position:absolute; bottom:30px; width:100%;
    text-align:center; pointer-events:none; z-index:100;
}
.guide { color:rgba(255,255,255,.6); font-size:13px; margin-bottom:20px; }
button {
    pointer-events:auto;
    padding:15px 50px;
    font-size:16px;
    font-weight:800;
    border-radius:30px;
    border:2px solid #FFD700;
    background:linear-gradient(#D32F2F,#8B0000);
    color:white;
    cursor:pointer;
    animation:pulse 1.5s infinite;
}
@keyframes pulse {
    0%{transform:scale(1)}
    50%{transform:scale(1.05)}
    100%{transform:scale(1)}
}
#camera-preview {
    position:absolute; top:15px; right:15px;
    width:120px; height:90px;
    transform:scaleX(-1); opacity:.6;
}
#copyright {
    position:absolute; bottom:10px; right:15px;
    color:rgba(255,255,255,.3); font-size:12px;
}
</style>
</head>

<body>

<div id="ui-layer">
    <div class="guide">üñê Open: Explode | ü´∂ Heart: Love | ‚úä Fist: Tree</div>
    <button id="btnStart" onclick="startSystem()">START MAGIC</button>
</div>

<div id="copyright">¬© vandiep</div>

<div id="canvas-container"></div>
<video class="input_video" style="display:none"></video>
<canvas id="camera-preview"></canvas>

<script>
/* ================= MUSIC ================= */
const bgMusic = new Audio("./audio.mp3");
bgMusic.loop = true;
bgMusic.volume = 1;

/* ================= GLOBALS ================= */
let scene, camera, renderer;
let groupGold, groupRed, groupGift;
let snowSystem;
let photoMeshes = [];
let state = 'TREE';
let selectedIndex = 0;
let handX = 0.5;

let lastSnowUpdate = 0;
let handBusy = false;

/* ================= CONFIG ================= */
const CONFIG = {
    goldCount: 2000,
    redCount: 300,
    giftCount: 150,
    explodeRadius: 65,
    photoOrbitRadius: 25,
    treeHeight: 70,
    treeBaseRadius: 35
};

/* ================= TEXTURES ================= */
const loader = new THREE.TextureLoader();
const photoTextures = [
    './image1.jpeg','./image2.jpeg','./image3.jpeg',
    './image4.jpeg','./image5.jpeg'
].map(p => loader.load(p));

function glow(color){
    const c=document.createElement('canvas');
    c.width=c.height=128;
    const ctx=c.getContext('2d');
    const g=ctx.createRadialGradient(64,64,0,64,64,50);
    g.addColorStop(0,color);
    g.addColorStop(1,'transparent');
    ctx.fillStyle=g;
    ctx.fillRect(0,0,128,128);
    return new THREE.CanvasTexture(c);
}

const textures = {
    gold: glow('#FFD700'),
    red: glow('#FF0000'),
    gift: glow('#FFFFFF')
};

/* ================= INIT ================= */
function init3D(){
    scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, 0.002);

    camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
    camera.position.z = 100;

    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(Math.min(devicePixelRatio,2));
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    groupGold = createParticles('gold', CONFIG.goldCount, 2);
    groupRed  = createParticles('red',  CONFIG.redCount,  3);
    groupGift = createParticles('gift', CONFIG.giftCount, 3);

    createPhotos();
    createSnow();
    animate();
}

/* ================= PARTICLES ================= */
function createParticles(type, count, size){
    const pos=[], tree=[], explode=[], heart=[];
    for(let i=0;i<count;i++){
        const h=Math.random()*CONFIG.treeHeight;
        const y=h-CONFIG.treeHeight/2;
        const r=(1-h/CONFIG.treeHeight)*CONFIG.treeBaseRadius*Math.random();
        const a=Math.random()*Math.PI*2;

        tree.push(r*Math.cos(a), y, r*Math.sin(a));
        explode.push(
            (Math.random()-.5)*CONFIG.explodeRadius,
            (Math.random()-.5)*CONFIG.explodeRadius,
            (Math.random()-.5)*CONFIG.explodeRadius
        );
        heart.push(
            (Math.random()-.5)*30,
            (Math.random()-.5)*20,
            (Math.random()-.5)*10
        );
        pos.push(tree[i*3], tree[i*3+1], tree[i*3+2]);
    }

    const g=new THREE.BufferGeometry();
    g.setAttribute('position', new THREE.Float32BufferAttribute(pos,3));
    g.userData = { tree, explode, heart };

    const m=new THREE.PointsMaterial({
        size,
        map: textures[type],
        transparent:true,
        blending: THREE.AdditiveBlending,
        depthWrite:false
    });

    const p=new THREE.Points(g,m);
    scene.add(p);
    return p;
}

/* ================= PHOTOS ================= */
function createPhotos(){
    const geo=new THREE.PlaneGeometry(8,8);
    photoTextures.forEach(t=>{
        const mat=new THREE.MeshBasicMaterial({map:t, side:THREE.DoubleSide});
        const mesh=new THREE.Mesh(geo,mat);
        mesh.visible=false;
        scene.add(mesh);
        photoMeshes.push(mesh);
    });
}

/* ================= SNOW (PERF SAFE) ================= */
function createSnow(){
    const count = 500; // ‚¨ÖÔ∏è SAFE
    const pos = [];
    const spd = [];

    for(let i=0;i<count;i++){
        pos.push(
            (Math.random()-0.5)*600,
            Math.random()*300,
            (Math.random()-0.5)*600
        );
        spd.push(0.3 + Math.random()*0.7);
    }

    const g = new THREE.BufferGeometry();
    g.setAttribute('position', new THREE.Float32BufferAttribute(pos,3));
    g.setAttribute('speed', new THREE.Float32BufferAttribute(spd,1));

    const m = new THREE.PointsMaterial({
        color:0xffffff,
        size:1.5,
        transparent:true,
        opacity:0.8,
        depthWrite:false
    });

    snowSystem = new THREE.Points(g,m);
    scene.add(snowSystem);
}

/* ================= ANIMATE ================= */
function animate(){
    requestAnimationFrame(animate);
    const now = performance.now();

    // ‚ùÑÔ∏è snow at 30 FPS & yield to hands
    if (!handBusy && snowSystem && now - lastSnowUpdate > 33) {
        lastSnowUpdate = now;
        const p = snowSystem.geometry.attributes.position.array;
        const s = snowSystem.geometry.attributes.speed.array;
        for(let i=0;i<p.length;i+=3){
            p[i+1] -= s[i/3];
            if(p[i+1] < -150) p[i+1] = 200;
        }
        snowSystem.geometry.attributes.position.needsUpdate = true;
    }

    updateGroup(groupGold);
    updateGroup(groupRed);
    updateGroup(groupGift);

    renderer.render(scene, camera);
}

function updateGroup(g){
    const pos = g.geometry.attributes.position.array;
    const target =
        state === 'TREE'  ? g.geometry.userData.tree :
        state === 'HEART' ? g.geometry.userData.heart :
                            g.geometry.userData.explode;

    for(let i=0;i<pos.length;i++){
        pos[i] += (target[i] - pos[i]) * 0.08;
    }
    g.geometry.attributes.position.needsUpdate = true;
}

/* ================= START ================= */
function startSystem(){
    document.getElementById('btnStart').style.display='none';
    bgMusic.play();
    init3D();

    const video=document.querySelector('.input_video');
    const canvas=document.getElementById('camera-preview');
    const ctx=canvas.getContext('2d');

    const hands=new Hands({
        locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
    });

    hands.setOptions({
        maxNumHands:2,
        minDetectionConfidence:.5,
        minTrackingConfidence:.5
    });

    hands.onResults(r=>{
        handBusy = true;
        ctx.drawImage(r.image,0,0,120,90);

        if(!r.multiHandLandmarks.length){
            state='TREE';
            handBusy = false;
            return;
        }

        const lm=r.multiHandLandmarks[0];
        const d=Math.hypot(lm[8].x-lm[4].x,lm[8].y-lm[4].y);
        state = d < 0.05 ? 'PHOTO' : 'EXPLODE';

        handBusy = false;
    });

    new Camera(video,{
        onFrame:async()=>hands.send({image:video}),
        width:320, height:240
    }).start();
}

window.addEventListener('resize',()=>{
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
});
</script>

</body>
</html>
